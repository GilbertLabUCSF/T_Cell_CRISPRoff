---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
library(methylKit)
library(edgeR)
library(readr)
library(magrittr)
library(tidyverse)
library(data.table)
library(ggplot2)
```

```{r}
readBismarkCoverage<-function( location,sample.id,assembly="unknown",treatment,
                                    context="CpG",min.cov=10)
{
  if(length(location)>1){
    stopifnot(length(location)==length(sample.id),
              length(location)==length(treatment))
  }
  
  result=list()
  for(i in 1:length(location)){
    df=fread(location[[i]],data.table=FALSE)
  
    # remove low coverage stuff
    df=df[ (df[,5]+df[,6]) >= min.cov ,]
    
    
    
    
    # make the object (arrange columns of df), put it in a list
    result[[i]]= new("methylRaw",data.frame(chr=df[,1],start=df[,2],end=df[,3],
                               strand="*",coverage=(df[,5]+df[,6]),
                               numCs=df[,5],numTs=df[,6]),
        sample.id=sample.id[[i]],
        assembly=assembly,context=context,resolution="base"
        )
  }
  
  if(length(result) == 1){
    return(result[[1]])
  }else{
    
    new("methylRawList",result,treatment=treatment)
  }
  
}
```

```{r}

# List of file paths
file_paths <- list(
  "exp_1/methylation_coverage/CD81_DONOR1_REP2_1_val_1_bismark_bt2_pe.deduplicated.bismark.cov.gz",
  "exp_1/methylation_coverage/CD81_DONOR2_REP1_1_val_1_bismark_bt2_pe.deduplicated.bismark.cov.gz",
  "exp_1/methylation_coverage/CD81_DONOR2_REP2_1_val_1_bismark_bt2_pe.deduplicated.bismark.cov.gz",
  "exp_1/methylation_coverage/CONTROL_DONOR1_REP1_1_val_1_bismark_bt2_pe.deduplicated.bismark.cov.gz",
  "exp_1/methylation_coverage/CONTROL_DONOR1_REP2_1_val_1_bismark_bt2_pe.deduplicated.bismark.cov.gz",
  "exp_1/methylation_coverage/CONTROL_DONOR2_REP1_1_val_1_bismark_bt2_pe.deduplicated.bismark.cov.gz",
  "exp_1/methylation_coverage/CONTROL_DONOR2_REP2_1_val_1_bismark_bt2_pe.deduplicated.bismark.cov.gz"
)

sample_names <- c("CD81_donor1_rep2", "CD81_donor2_rep1", "CD81_donor2_rep2",
                "control_donor1_rep1", "control_donor1_rep2", 
                "control_donor2_rep1", "control_donor2_rep2")

# Treatment vector, assuming the first three are treated (1) and the rest are control (0)
treatment_vector <- c(1, 1, 1, 0, 0, 0, 0)

# Read methylation data
methylationDataList <- readBismarkCoverage(
  location = file_paths,
  sample.id = sample_ids,
  assembly = 'hg38',
  context = 'CpG',
  treatment = treatment_vector
)

```

```{r}
filteredMethylationData <- filterByCoverage(methylationDataList, lo.count = 10, lo.perc = NULL, hi.count = NULL, hi.perc = 99.9)
methylationBaseObj <- unite(filteredMethylationData, destrand = FALSE)
```

```{r}
# Extract donor information
donor <- factor(sub("^[^_]+_([^_]+)_rep[0-9]+$", "\\1", sample_names))


# Extract replicate information
replicate <- factor(sub(".*_", "", sample_names))

# Extract treatment
treatment <- factor(sample_names %>% str_split_fixed(.,'_',2) %>% .[,1])

covariates = data.frame(donor=donor)
```


```{r}
# Assuming you have vectors 'donor' and 'replicate' as your covariates
# design <- model.matrix(~ donor + replicate)

# Tile the genome and then perform the analysis on these tiles
tiledObj <- tileMethylCounts(methylationBaseObj, tile.size = 1000, step.size = 1000, mc.cores=16)
```


```{r}
# Perform differential methylation analysis
diffMethResults <- calculateDiffMeth(tiledObj, covariates = covariates, mc.cores=32)
```

```{r}
# Filter to keep only standard chromosomes
standardChromosomes <- grepl("^chr[0-9XY]+$", diffMethDataFrame$chr)
filteredDiffMethDataFrame <- diffMethDataFrame[standardChromosomes, ]

# You might need to adjust p-values for multiple testing if not already done
filteredDiffMethDataFrame$p.adjusted <- p.adjust(filteredDiffMethDataFrame$pvalue, method = "BH")

# Transform the p-values
filteredDiffMethDataFrame$neg_log10_pval <- -log10(filteredDiffMethDataFrame$p.adjusted)
```

```{r}
# Creating the Manhattan plot
ggplot(filteredDiffMethDataFrame, aes(x = start, y = neg_log10_pval, color = as.factor(chr))) +
  geom_point(alpha = 0.5) +
  scale_color_hue(l = 40) +  # Different color for each chromosome
  labs(x = "Genomic Position", y = "-log10(Adjusted P-Value)", color = "Chromosome") +
  theme_bw() +
  facet_wrap(~chr, nrow=4)+
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r}
# Creating the Manhattan plot with chromosomes as categories
ggplot(diffMethDataFrame, aes(x = as.factor(chr), y = neg_log10_pval)) +
  geom_jitter(aes(color = as.factor(chr)), width = 0.2, size = 1.5, alpha = 0.6) +
  scale_color_hue(l = 40) +  # Different color for each chromosome
  labs(x = "Chromosome", y = "-log10(Adjusted P-Value)", color = "Chromosome") +
  theme_bw() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.spacing = unit(2, "lines")
  )
```

